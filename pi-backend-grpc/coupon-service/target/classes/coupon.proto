syntax = "proto3";

package coupon;

option java_multiple_files = true;
option java_package = "com.example.coupon.proto";
option java_outer_classname = "CouponProto";

// 优惠券服务
service CouponService {
  // 新用户注册送优惠券
  rpc GrantNewUserCoupons(GrantNewUserCouponsRequest) returns (GrantNewUserCouponsResponse);
  
  // 获取用户可用优惠券列表（按优惠金额排序）
  rpc GetAvailableCoupons(GetAvailableCouponsRequest) returns (GetAvailableCouponsResponse);
  
  // 使用优惠券
  rpc UseCoupon(UseCouponRequest) returns (UseCouponResponse);
  
  // 验证优惠券是否可用
  rpc ValidateCoupon(ValidateCouponRequest) returns (ValidateCouponResponse);
  
  // 创建优惠券模板
  rpc CreateCouponTemplate(CreateCouponTemplateRequest) returns (CreateCouponTemplateResponse);
  
  // 领取优惠券
  rpc ClaimCoupon(ClaimCouponRequest) returns (ClaimCouponResponse);
}

// 优惠券类型
enum CouponType {
  COUPON_TYPE_UNSPECIFIED = 0;
  FULL_REDUCTION = 1;  // 满减
  DISCOUNT = 2;        // 折扣
  DIRECT_REDUCTION = 3; // 立减
}

// 优惠券状态
enum CouponStatus {
  COUPON_STATUS_UNSPECIFIED = 0;
  UNUSED = 1;    // 未使用
  USED = 2;      // 已使用
  EXPIRED = 3;   // 已过期
}

// 优惠券信息
message CouponInfo {
  int64 id = 1;
  int64 user_id = 2;
  int64 template_id = 3;
  string coupon_code = 4;
  string name = 5;
  CouponType type = 6;
  double discount_value = 7;
  double min_amount = 8;
  double max_discount = 9;
  CouponStatus status = 10;
  string expire_time = 11;
  double calculated_discount = 12; // 针对订单金额计算的优惠金额
}

// 新用户送券请求
message GrantNewUserCouponsRequest {
  int64 user_id = 1;
}

message GrantNewUserCouponsResponse {
  bool success = 1;
  string message = 2;
  repeated CouponInfo coupons = 3;
}

// 获取可用优惠券请求
message GetAvailableCouponsRequest {
  int64 user_id = 1;
  double order_amount = 2; // 订单金额，用于筛选和计算优惠
}

message GetAvailableCouponsResponse {
  repeated CouponInfo coupons = 1; // 按优惠金额从高到低排序
  CouponInfo recommended_coupon = 2; // 推荐使用的优惠券（优惠最高）
}

// 使用优惠券请求
message UseCouponRequest {
  int64 user_id = 1;
  string coupon_code = 2;
  int64 order_id = 3;
  double order_amount = 4;
}

message UseCouponResponse {
  bool success = 1;
  string message = 2;
  double discount_amount = 3;
  double final_amount = 4;
}

// 验证优惠券请求
message ValidateCouponRequest {
  int64 user_id = 1;
  string coupon_code = 2;
  double order_amount = 3;
}

message ValidateCouponResponse {
  bool valid = 1;
  string message = 2;
  double discount_amount = 3;
}

// 创建优惠券模板请求
message CreateCouponTemplateRequest {
  string name = 1;
  CouponType type = 2;
  double discount_value = 3;
  double min_amount = 4;
  double max_discount = 5;
  int32 total_count = 6;
  string start_time = 7;
  string end_time = 8;
}

message CreateCouponTemplateResponse {
  bool success = 1;
  string message = 2;
  int64 template_id = 3;
}

// 领取优惠券请求
message ClaimCouponRequest {
  int64 user_id = 1;
  int64 template_id = 2;
}

message ClaimCouponResponse {
  bool success = 1;
  string message = 2;
  CouponInfo coupon = 3;
}
